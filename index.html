<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test svg</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body style="background-color: rgb(224, 224, 224);">
    <div class="container-sm text-center">
        <h1>Card Maker v1.0</h1>
        <div id="svgCard" class="pb-4">
            <svg id="card" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 178.58 249.45">
            <defs>
                <style>
                .cls-1, .cls-2, .cls-3, .cls-4 {
                    fill: #ffffff;
                }

                .cls-1, .cls-2, .cls-3, .cls-4, .cls-5, .cls-6 {
                    stroke: #1d1d1b;
                    stroke-miterlimit: 10;
                }

                .cls-1, .cls-5 {
                    stroke-width: .57px;
                }

                .cls-7 {
                    font-size: 14px;
                    letter-spacing: -.01em;
                }

                .cls-7, .cls-8, .cls-9, .cls-10, .cls-11, .cls-12, .cls-13, .cls-14, .cls-15, .cls-16 {
                    fill: #1d1d1b;
                }

                .cls-7, .cls-10, .cls-11, .cls-13, .cls-14, .cls-15 {
                    font-family: SourceSerifPro-Regular, 'Source Serif Pro';
                }

                .cls-17 {
                    letter-spacing: -.07em;
                }

                .cls-18 {
                    letter-spacing: 0em;
                }

                .cls-19 {
                    letter-spacing: 0em;
                }

                .cls-20 {
                    letter-spacing: 0em;
                }

                .cls-21 {
                    letter-spacing: -.01em;
                }

                .cls-22 {
                    letter-spacing: 0em;
                }

                .cls-23 {
                    letter-spacing: .02em;
                }

                .cls-2 {
                    stroke-width: 5.67px;
                }

                .cls-8, .cls-9, .cls-12, .cls-16 {
                    font-weight: 600;
                }

                .cls-8, .cls-12 {
                    font-family: SourceSerifPro-SemiboldIt, 'Source Serif Pro';
                    font-style: italic;
                }

                .cls-8, .cls-14, .cls-16 {
                    font-size: 9px;
                }

                .cls-24 {
                    letter-spacing: 0em;
                }

                .cls-3, .cls-6 {
                    stroke-width: .28px;
                }

                .cls-9, .cls-10, .cls-12 {
                    font-size: 6px;
                }

                .cls-9, .cls-16 {
                    font-family: SourceSerifPro-Semibold, 'Source Serif Pro';
                }

                .cls-25 {
                    letter-spacing: -.02em;
                }

                .cls-26 {
                    letter-spacing: 0em;
                }

                .cls-27 {
                    letter-spacing: -.02em;
                }

                .cls-4 {
                    stroke-width: .71px;
                }

                .cls-28 {
                    letter-spacing: 0em;
                }

                .cls-10 {
                    letter-spacing: -.01em;
                }

                .cls-11 {
                    font-size: 5px;
                }

                .cls-5, .cls-6 {
                    fill: none;
                }

                .cls-29 {
                    letter-spacing: 0em;
                }

                .cls-30 {
                    letter-spacing: -.02em;
                }

                .cls-31 {
                    letter-spacing: 0em;
                }

                .cls-32 {
                    letter-spacing: 0em;
                }

                .cls-13 {
                    font-size: 4.5px;
                }

                .cls-33 {
                    letter-spacing: 0em;
                }

                .cls-34 {
                    letter-spacing: -.01em;
                }

                .cls-15 {
                    font-size: 12px;
                }

                .cls-35 {
                    letter-spacing: -.05em;
                }

                .cls-36 {
                    letter-spacing: 0em;
                }
                </style>
            </defs>
            <g id="Sfondo_Carta">
                <rect id="Cornice" class="cls-2" x="2.83" y="2.83" width="172.91" height="243.78" rx="4.3" ry="4.3"/>
            </g>
            <g id="Fondamenta_Carta">
                <rect id="Barra_Generale" class="cls-1" x="5.39" y="5.66" width="167.81" height="19.87"/>
                <rect id="Barra_Generale_2" class="cls-6" x="7.09" y="7.09" width="164.41" height="17.01"/>
                <rect id="Cornice_Foto" class="cls-3" x="11.34" y="27.02" width="155.91" height="87.7"/>
                <rect id="Barra_Informazioni" class="cls-4" x="8.5" y="116.22" width="161.57" height="17.01" rx="2.85" ry="2.85"/>
                <line id="Linea_Effetti_1" class="cls-6" x1="5.67" y1="167.24" x2="172.91" y2="167.24"/>
                <line id="Linea_Competenza_Iniziativa_1" class="cls-5" x1="153.07" y1="164.41" x2="153.07" y2="136.06"/>
                <line id="Linea_Competenza_Iniziativa_2" class="cls-5" x1="153.07" y1="150.24" x2="161.57" y2="150.24"/>
                <line id="Linea_Competenza_Iniziativa_2-2" data-name="Linea_Competenza_Iniziativa_2" class="cls-5" x1="168.66" y1="150.24" x2="177.17" y2="150.24"/>
                <line id="Linea_Attributi_1" class="cls-5" x1="5.67" y1="136.06" x2="172.91" y2="136.06"/>
                <line id="Linea_Attributi_2" class="cls-5" x1="5.67" y1="164.41" x2="172.91" y2="164.41"/>
                <line id="Linea_Generiche" class="cls-5" x1="5.67" y1="238.11" x2="172.91" y2="238.11"/>
                <g id="Fondamenta_Portamento">
                <rect id="Portamento" class="cls-5" x="152.38" y="217.08" width="17.01" height="17.01" transform="translate(-112.39 179.84) rotate(-45)"/>
                </g>
            </g>
            <g id="Attributi_Dinamici" data-name="Attributi Dinamici">
                <g id="Generiche">
                <g id="Copyright">
                    <text id="Carattere_Copyright" class="cls-13" transform="translate(84.6 242.61)">Copyright</text>
                </g>
                <g id="Codice_Espansione">
                    <text id="Carattere_Collezione" class="cls-11" transform="translate(34.02 242.79) scale(1 1.1)" text-anchor="middle">Codice Espansione</text>
                </g>
                <g id="Rarità">
                    <rect class="cls-5" x="158.74" y="238.11" width="11.34" height="5.67"/>
                    <image id="Icona_Rarità" x="158.74" y="238.11" width="11.34" height="5.67" preserveAspectRatio="none" href="./images/trasparent_image.png" alt=""></image>
                </g>
                </g>
                <g id="Livello">
                <text id="Valore_Livello" class="cls-16" transform="translate(160.89 228.65)" text-anchor="middle">LvL</text>
                </g>
                <g id="Portamento-2" data-name="Portamento">
                <rect id="Colore_Portamento" class="cls-5" x="152.38" y="217.08" width="17.01" height="17.01" transform="translate(-112.39 179.84) rotate(-45)"/>
                </g>
                <g id="Effetti_Totali">
                <g id="Fazione">
                    <text id="Carattere_Fazione" class="cls-8" transform="translate(7.09 177.62)">FAZIONE:</text>
                </g>
                <g id="Effetti">
                    <text id="Carattere_Effetti" class="cls-8" transform="translate(7.09 189.4)">EFFETTI:</text>
                </g>
                <g id="Passive">
                    <text id="Carattere_Passive" class="cls-12" transform="translate(7.09 218.39)"></text>
                </g>
                </g>
                <g id="Attributi_2" data-name="Attributi 2">
                <g id="Iniziativa">
                    <text id="Carattere_Iniziativa" class="cls-15" transform="translate(162.99 161.76)" text-anchor="middle">13</text>
                </g>
                <g id="Competenza">
                    <text id="Carattere_Competenza" class="cls-15" transform="translate(162.99 147.58)" text-anchor="middle">12</text>
                </g>
                </g>
                <g id="Attributi">
                <g id="Resistenza">
                    <text id="Valore_Resistenza" class="cls-14" transform="translate(107.72 146.48)">RES:</text>
                </g>
                <g id="Difesa">
                    <text id="Valore_Difesa" class="cls-14" transform="translate(59.53 146.48)">DEF:</text>
                </g>
                <g id="Attacco">
                    <text id="Valore_Attacco" class="cls-14" transform="translate(11.34 146.48)">ATK:</text>
                </g>
                <g id="Aura">
                    <text id="Valore_Aura" class="cls-14" transform="translate(11.34 160.65)">AUR:</text>
                </g>
                <g id="Tecnica">
                    <text id="Valore_Tecnica" class="cls-14" transform="translate(59.53 160.65)">TEC:</text>
                </g>
                <g id="Grinta">
                    <text id="Valore_Grinta" class="cls-14" transform="translate(107.72 160.65)">GRI:</text>
                </g>
                </g>
                <g id="Descrizione">
                <g id="Genere_Razza">
                    <text id="Carattere_Tipo_Razza" class="cls-9" transform="translate(11.34 124.09)">Genere Razza</text>
                </g>
                <g id="Taglia">
                    <text id="Carattere_Taglia" class="cls-9" transform="translate(75.12 122.67)">Taglia:</text>
                </g>
                <g id="Peso">
                    <text id="Carattere_Peso" class="cls-9" transform="translate(75.12 131.17)">Peso:</text>
                </g>
                <g id="Movimento">
                    <text id="Carattere_Movimento" class="cls-9" transform="translate(121.89 122.67)">Movimento:</text>
                </g>
                <g id="Salto">
                    <text id="Carattere_Salto" class="cls-9" transform="translate(121.89 131.17)">Salto:</text>
                </g>
                </g>
                <g id="Principale">
                <g id="Nome">
                    <text id="Carattere_Nome" class="cls-7" transform="translate(9.92 20.76)">Nome</text>
                </g>
                <g id="Punti_Salute">
                    <text id="Carattere_Punti_Vita" class="cls-10" transform="translate(148.82 13.56) scale(.9 1)">HP x</text>
                </g>
                <g id="Elementi">
                    <rect class="cls-6" x="148.82" y="15.59" width="11.34" height="8.5"/>
                    <image id="Icona_Elemento_1" x="148.82" y="15.59" width="11.34" height="8.5" preserveAspectRatio="none" href="./images/trasparent_image.png" alt=""></image>
                    <rect class="cls-6" x="160.16" y="15.59" width="11.34" height="8.5"/>
                    <image id="Icona_Elemento_2" x="160.16" y="15.59" width="11.34" height="8.5" preserveAspectRatio="none" href="./images/trasparent_image.png" alt=""></image>
                </g>
                <g id="Immagine">
                    <rect style="stroke-width: 1px;" class="cls-3" x="11.34" y="27.02" width="155.91" height="87.7" fill="rgba(124,240,10,0.5)"></rect>
                    <image id="Sfondo_Immagine" width="155.91" height="87.7" x="11.34" y="27.02" preserveAspectRatio="none" href="./images/trasparent_image.png" alt=""></image>
                </g>
                </g>
            </g>
            </svg>
        </div>
        <button id="downloadBtn" class="btn btn-success">Download</button>
        <div id="credits" class="m-2">
            <p class="p-1 m-0">Made by SimoInCodice</p>
            <a href="https://github.com/SimoInCodice/CardMaker"><img src="./images/github-mark.svg" width="25px" alt="githubLogo"></a>
        </div>
    </div>
    <!-- Text Modal -->
    <div class="modal fade" id="textModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifica il testo</h5>
                <button id="textModalCloseXBtn" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label id="newTextLabel" for="newText">Testo</label>
                <input type="text" name="newText" id="newText">
                <p id="newTextError" class="text-danger text-center"></p>
            </div>
            <div class="modal-footer">
                <button id="textModalCloseBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="textModalSaveBtn" type="button" class="btn btn-success">Save changes</button>
            </div>
            </div>
        </div>
    </div>
    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifica l'immagine</h5>
                <button id="imageModalCloseXBtn" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label id="newImageLabel" for="newImage">Immagine</label>
                <input type="file" name="newImage" id="newImage">
            </div>
            <div class="modal-footer">
                <button id="imageModalCloseBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="imageModalSaveBtn" type="button" class="btn btn-success">Save changes</button>
            </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    
    <script>
        // SVG element
        const card = document.querySelector("#card");
        // Init the custom context menu action
        /* Selected target obj */
        let targetObj = null;
        // Pointing to the modals
        const bTextModal = new bootstrap.Modal("#textModal");
        const bImageModal = new bootstrap.Modal("#imageModal");
        console.log(bTextModal);
        // Pointing the the DOM objects
        // Pointing to the modals

        /* Text modal */
        const textModal = document.querySelector("#textModal");
        const textInput = document.querySelector("#newText");
        const textLabel = document.querySelector("#newTextLabel");
        const textError = document.querySelector("#newTextError");
        /* Buttons */
        const textModalSaveBtn = document.querySelector("#textModalSaveBtn");
        const textModalCloseBtn = document.querySelector("#textModalCloseBtn");
        const textModalCloseXBtn = document.querySelector("#textModalCloseXBtn");
        /* Text modal save changes button action */
        textModalSaveBtn.addEventListener("click", (e) => {
            // Check the obj tag
            if (targetObj.localName !== "text") return alert("Errore: Non è stato possibile modificare il testo");
            // Alert the user about the blank text field
            if (!textInput.value) return alert("Non è possibile lasciare un campo testo vuoto");
            // Modify the text of the targetObj
            targetObj.textContent = textInput.value;
            // Remove the error message
            textError.textContent = "";
            // Hide the modal
            bTextModal.hide();
        });
        /* Modal close action */
        textModal.addEventListener("hide.bs.modal", (e) => {
            // Remove the error message
            textError.textContent = "";
        });
        /*
        // Close button action
        textModalCloseBtn.addEventListener("click", closeTextModalAction);
        // Close button (X) action
        textModalCloseXBtn.addEventListener("click", closeTextModalAction);
        */
        /* When the user is typing in something */
        textInput.addEventListener("input", (e) => {
            // Check if the field is blank
            if (!textInput.value) {
                textError.style.display = "block";
                textError.innerText = "Inserire almeno un carattere";
            } else {
               textError.style.display = "none";
               textError.innerText = "";
            }
        });

        /* Image modal */
        const imageModal = document.querySelector("#imageModal");
        const imageInput = document.querySelector("#newImage");
        const imageLabel = document.querySelector("#newImageLabel");
        /* Buttons */
        const imageModalSaveBtn = document.querySelector("#imageModalSaveBtn");
        const imageModalCloseBtn = document.querySelector("#imageModalCloseBtn");
        const imageModalCloseXBtn = document.querySelector("#imageModalCloseXBtn");
        /* Image modal save changes button action */
        imageModalSaveBtn.addEventListener("click", (e) => {
            // Check the obj tag
            if (targetObj.localName !== "image") return alert("Errore: Non è stato possibile modificare l'immagine");
            // Base64 of the file
            const [file] = imageInput.files;
            if (!file) return alert("Errore: Non è stata caricata un'immagine");
            const fileReader = new FileReader();
            fileReader.readAsDataURL(file);
            fileReader.onloadend = (e) => {
                const result = e.currentTarget.result;
                // Modify the href of the targetObj
                targetObj.href.baseVal = result;
                console.log(targetObj.href);
            }
            // Hide the modal
            bImageModal.hide();
            // Clear the image input
            imageInput.value = null;
        });

        // When a user upload an image
        imageInput.addEventListener("input", (e) => {
            
        });

        /* Context menu event */
        document.oncontextmenu = (e) => {
            // Block the normal activity of the context menu
            e.preventDefault();
            console.log(e.target.localName);
            const target = e.target;
            // Save the target
            targetObj = target;
            const targetTag = e.target.localName;
            // Check the tag
            if (targetTag === "text") {
                bTextModal.show();
                // Change the text inside the input to the content of the selected text
                const text = target.textContent;
                console.log(text);
                textInput.value = text;
                // Insert the element id into the input label
                textLabel.innerText = target.id;
            } else if (targetTag === "image") {
                console.log(e.target.href);
                bImageModal.show();
                // Insert the element id into the input label
                console.log(textLabel.innerText);
                imageLabel.innerText = target.id;
            }
        };

        // Download the custom card
        async function downloadCard(svgEl, moltiplicator) {
            // From SVG element create a Blob
            const svgXml = new XMLSerializer().serializeToString(svgEl);
            console.log(svgXml);
            const blob = new Blob([svgXml], { type: 'image/svg+xml;charset=utf-8' } );
            const url = URL.createObjectURL(blob);
            console.log(url);
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width * moltiplicator;
                canvas.height = img.height * moltiplicator;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff00'; // Fill with a trasparent color
                ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(img,0,0);
                // Create the link
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = (svgEl.value||'card') + '.png';
                // Click on the link
                a.click(); 
                // Remove the link
                URL.revokeObjectURL(url);
            };
            img.src = url;
        }

        // Download the card on the click
        document.querySelector("#downloadBtn").addEventListener("click", async (e) => {
            console.log(card);
            await downloadCard(card, 4);
        });
    </script>

</body>
</html>